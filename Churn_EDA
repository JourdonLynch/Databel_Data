-- Average account length of all accounts

SELECT
  ROUND(AVG(`Account Length _in months_`),2)
FROM
  Databel.Data


-- Average account length of churned accounts

SELECT
  ROUND(AVG(`Account Length _in months_`),2) AS avg_account_length
FROM
  Databel.Data
WHERE
  `Churn Label` = TRUE


-- Churn rate of all customers

SELECT
 CONCAT(
   ROUND(
     (
       SELECT
         COUNT(`Customer ID`)
       FROM
         Databel.Data
       WHERE
         `Churn Label` = TRUE
     ) * (100)
       / (
         SELECT
           COUNT(`Customer ID`)
         FROM
           Databel.Data
       ),
     2),
   "%") AS churn_rate


-- Churn rate among internationally active customers by international plan status

SELECT
  `Intl Plan`,
  CONCAT(
    ROUND(
      SUM(CASE WHEN `Churn Label` = TRUE THEN 1 ELSE 0 END) * 100.0
      / COUNT(*),
      2
    ),
    '%'
  ) AS churn_rate
FROM Databel.Data
WHERE `Intl Active` = TRUE
GROUP BY `Intl Plan`
ORDER BY `Intl Plan`;


-- Churn rate of customers with 0-5 GB, by unlimited plan status

SELECT
  `Unlimited Data Plan`,
  CONCAT(
    ROUND(
      100.0
        * SUM(CASE WHEN `Churn Label` = TRUE THEN 1 ELSE 0 END)
        / COUNT(`Customer ID`),
      2),
    '%') AS churn_rate
FROM Databel.Data
WHERE `Avg Monthly GB Download` <= 5
GROUP BY `Unlimited Data Plan`
ORDER BY `Unlimited Data Plan` DESC;

         

-- Churn rate of customers with 5-10 GB, by unlimited data plan

SELECT
  `Unlimited Data Plan`,
  CONCAT(
    ROUND(
      100.0
        * SUM(CASE WHEN `Churn Label` = TRUE THEN 1 ELSE 0 END)
        / COUNT(`Customer ID`),
      2),
    '%') AS churn_rate
FROM Databel.Data
WHERE `Avg Monthly GB Download` > 5 AND `Avg Monthly GB Download` <= 10
GROUP BY `Unlimited Data Plan`
ORDER BY `Unlimited Data Plan` DESC;


-- Churn Rate by payment type

SELECT
  `Payment Method`,
  CONCAT(
    ROUND(
      SUM(CASE WHEN `Churn label` = TRUE THEN 1 ELSE 0 END)
        * (100)
        / COUNT(*),
      2),
    '%')
    AS churn_rate
FROM Databel.Data
GROUP BY `Payment Method`
ORDER BY
  ROUND(
    SUM(CASE WHEN `Churn label` = TRUE THEN 1 ELSE 0 END) * 100.0
    / COUNT(*),
    2
  ) DESC

-- Churn Rate by contract type

SELECT
  `Contract Type`,
  CONCAT(
    ROUND(
      SUM(CASE WHEN `Churn label` = TRUE THEN 1 ELSE 0 END)
        * (100)
        / COUNT(*),
      2),
    '%')
    AS churn_rate
FROM Databel.Data
GROUP BY `Contract Type`
ORDER BY
  ROUND(
    SUM(CASE WHEN `Churn label` = TRUE THEN 1 ELSE 0 END) * 100.0
    / COUNT(*),
    2
  ) DESC


-- Churn Rate of customers based on group status

 SELECT
  `Group`,
  ROUND(
    SUM(CASE WHEN `Churn Label` = TRUE THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2)
    AS churn_rate
FROM Databel.Data
GROUP BY `Group`
ORDER BY `Group`;


-- Churn rate by Churn Category

WITH churn_reasons AS (
  SELECT
    `Churn Category`,
    COUNT(*) AS churn_count
  FROM Databel.Data
  WHERE
    `Churn Label` = TRUE
    AND `Churn Category` IS NOT NULL
  GROUP BY
    `Churn Category`
)

SELECT
  `Churn Category`,
  ROUND(
    churn_count * 100.0 / SUM(churn_count) OVER (),
    2
  ) AS `Churn Rate`
FROM churn_reasons
ORDER BY churn_count DESC;
